---
// Typesense-powered search component with instant search
---

<!-- Search Container -->
<div id="search-modal-container" x-data="typesenseSearchModal()" x-init="init()" style="position: relative; z-index: 9999;">
  <!-- Search Trigger Button -->
  <button 
    @click="open = true"
    class="search-trigger flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white hover:border-[#54C4B6] transition-colors cursor-pointer"
  >
    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <span class="text-gray-600">Search...</span>
    <kbd class="hidden sm:inline-block px-2 py-1 text-xs bg-gray-100 rounded">⌘K</kbd>
  </button>

  <!-- Search Modal -->
  <div 
    x-show="open" 
    x-cloak
    @keydown.escape.window="open = false"
    class="fixed inset-0 z-[100]"
    role="dialog"
    aria-modal="true"
  >
    <!-- Backdrop -->
    <div 
      x-show="open"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      @click="open = false"
      class="absolute inset-0 bg-black/50 backdrop-blur-sm"
    ></div>
    
    <!-- Modal -->
    <div class="relative flex items-start justify-center pt-[10vh] px-4 sm:px-6 lg:px-8">
      <div 
        x-show="open"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95"
        @click.outside="open = false"
        class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden"
      >
        <!-- Search Header -->
        <div class="p-6 sm:p-8 border-b border-gray-200 bg-gradient-to-br from-gray-50 to-white">
          <div class="flex items-center gap-4 relative">
            <svg class="w-6 h-6 text-[#54C4B6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
              x-ref="searchInput"
              x-model="query"
              @input="search"
              @keydown.down.prevent="selectNext"
              @keydown.up.prevent="selectPrev"
              @keydown.enter.prevent="goToSelected"
              type="text"
              placeholder="Search blogs, whitepapers, and pages..."
              class="flex-1 text-lg bg-transparent outline-none placeholder-gray-400 text-gray-900 font-medium"
              autocomplete="off"
            />
            <button 
              @click="open = false"
              class="p-2 hover:bg-gray-100 rounded-lg transition-all duration-200 hover:scale-110"
            >
              <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Search stats -->
          <div x-show="query.length > 0 && !loading" class="mt-3 text-sm text-gray-500">
            <span x-text="`Found ${totalResults} results in ${searchTime}ms`"></span>
          </div>
        </div>
        
        <!-- Search Results -->
        <div class="max-h-[60vh] overflow-y-auto">
          <!-- Initial state -->
          <div x-show="!query && !loading" class="p-12 text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <p class="text-lg font-medium mb-2">Lightning-fast search</p>
            <p class="text-sm">Start typing to search with typo tolerance</p>
          </div>
          
          <!-- Loading state -->
          <div x-show="loading" class="p-12 text-center">
            <div class="inline-flex items-center gap-3">
              <svg class="animate-spin h-5 w-5 text-[#54C4B6]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-gray-600">Searching...</span>
            </div>
          </div>
          
          <!-- Results -->
          <div x-show="!loading && query && results.length > 0" class="px-4 sm:px-6 py-2">
            <template x-for="(result, index) in results" :key="result.document.id">
              <a
                :href="result.document.slug"
                @click="navigateToResult(result, $event)"
                @mouseenter="selectedIndex = index"
                :class="selectedIndex === index ? 'bg-[#e0f7fa] border-[#54C4B6] shadow-md' : 'bg-white border-gray-200 hover:bg-gray-50 hover:border-[#54C4B6]'"
                class="block p-4 mb-2 rounded-lg border transition-all duration-200"
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-900 text-lg mb-1">
                      <span x-html="result.highlight?.title?.snippet || result.document.title"></span>
                    </h3>
                    <p x-show="result.document.content" class="text-sm text-gray-600 line-clamp-2 mb-2">
                      <span x-html="result.highlight?.content?.snippet || result.document.content?.substring(0, 150) + '...'"></span>
                    </p>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                      <span x-text="formatDate(result.document.date_timestamp)"></span>
                      <template x-if="result.document.author">
                        <span x-text="'• ' + result.document.author"></span>
                      </template>
                    </div>
                  </div>
                  <span 
                    :class="getTypeStyles(result.document.type)"
                    class="px-2 py-1 text-xs rounded-full font-medium flex-shrink-0"
                    x-text="result.document.type.charAt(0).toUpperCase() + result.document.type.slice(1)"
                  ></span>
                </div>
              </a>
            </template>
          </div>
          
          <!-- No results -->
          <div x-show="!loading && query && results.length === 0" class="p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-lg font-medium text-gray-900 mb-2">No results found</p>
            <p class="text-sm text-gray-600">Try adjusting your search</p>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="p-4 sm:px-6 border-t border-gray-200 bg-gradient-to-br from-gray-50 to-gray-100/50 flex items-center justify-between text-sm text-gray-500">
          <div class="flex items-center gap-3 text-xs sm:text-sm">
            <span class="flex items-center gap-1.5">
              <kbd class="px-2 py-1 bg-white border border-gray-300 rounded text-xs font-mono shadow-sm">↑↓</kbd>
              Navigate
            </span>
            <span class="text-gray-400">•</span>
            <span class="flex items-center gap-1.5">
              <kbd class="px-2 py-1 bg-white border border-gray-300 rounded text-xs font-mono shadow-sm">Enter</kbd>
              Select
            </span>
          </div>
          <a href="/search" class="text-[#54C4B6] hover:text-[#54C4B6]/80 font-medium transition-colors">
            Advanced Search →
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  [x-cloak] { 
    display: none !important; 
  }
  
  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
</style>

<script is:inline>
  // Load Typesense from CDN
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/typesense@2.1.0-13/dist/typesense.min.js';
  script.onload = () => {
    // Dispatch event when Typesense is loaded
    window.dispatchEvent(new Event('typesense:loaded'));
  };
  document.head.appendChild(script);
</script>

<script is:inline>
  // Typesense search modal component
  function typesenseSearchModal() {
    return {
      open: false,
      query: '',
      results: [],
      loading: false,
      selectedIndex: -1,
      totalResults: 0,
      searchTime: 0,
      typesenseClient: null,
      
      init() {
        console.log('SearchTypesense: Initializing...');
        
        // Wait for Typesense to load
        const initTypesense = () => {
          if (window.Typesense) {
            console.log('SearchTypesense: Typesense library loaded, creating client...');
            // Initialize Typesense client
            this.typesenseClient = new window.Typesense.Client({
              nodes: [{
                host: 'typesense.bettercourses.org',
                port: 443,
                protocol: 'https'
              }],
              apiKey: '3dc57ebb7c46e57a5de5fa01d7c32c69855b3a04d26eaf5b5afff012d05641a4', // TODO: Replace with search-only key
              connectionTimeoutSeconds: 2
            });
            console.log('SearchTypesense: Client created');
          }
        };
        
        // Try to init immediately if Typesense is already loaded
        if (window.Typesense) {
          initTypesense();
        } else {
          console.log('SearchTypesense: Waiting for Typesense library to load...');
          // Otherwise wait for it to load
          window.addEventListener('typesense:loaded', initTypesense);
        }
        
        // Make search function globally available for navbar
        window.openSearchModal = () => {
          console.log('SearchTypesense: openSearchModal called');
          this.open = true;
        };
        console.log('SearchTypesense: window.openSearchModal registered');
        
        // Focus input when modal opens
        this.$watch('open', value => {
          if (value) {
            this.$nextTick(() => {
              this.$refs.searchInput?.focus();
            });
          } else {
            // Reset state when closing
            this.query = '';
            this.results = [];
            this.selectedIndex = -1;
          }
        });
        
        // Register global keyboard shortcut
        document.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            this.open = true;
          }
        });
      },
      
      async search() {
        if (!this.query.trim()) {
          this.results = [];
          this.totalResults = 0;
          return;
        }
        
        // Check if Typesense client is initialized
        if (!this.typesenseClient) {
          console.warn('Typesense client not initialized yet');
          return;
        }
        
        this.loading = true;
        const startTime = performance.now();
        
        try {
          const searchResult = await this.typesenseClient
            .collections('bcf-test') // TODO: Change to 'bcf-content' when ready
            .documents()
            .search({
              q: this.query,
              query_by: 'title,content,tags',
              query_by_weights: '3,1,2',
              highlight_full_fields: 'title,content',
              highlight_affix_num_tokens: 10,
              num_typos: 2,
              per_page: 20,
              sort_by: '_text_match:desc,date_timestamp:desc'
            });
          
          this.results = searchResult.hits || [];
          this.totalResults = searchResult.found || 0;
          this.searchTime = Math.round(performance.now() - startTime);
        } catch (error) {
          console.error('Search error:', error);
          this.results = [];
        } finally {
          this.loading = false;
          this.selectedIndex = -1;
        }
      },
      
      selectNext() {
        if (this.results.length > 0) {
          this.selectedIndex = Math.min(this.selectedIndex + 1, this.results.length - 1);
          this.scrollToSelected();
        }
      },
      
      selectPrev() {
        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
        this.scrollToSelected();
      },
      
      scrollToSelected() {
        // Implement scroll to selected item if needed
      },
      
      goToSelected() {
        if (this.selectedIndex >= 0 && this.results[this.selectedIndex]) {
          window.location.href = this.results[this.selectedIndex].document.slug;
        }
      },
      
      navigateToResult(result, event) {
        // Allow cmd/ctrl click to open in new tab
        if (!event.metaKey && !event.ctrlKey) {
          event.preventDefault();
          window.location.href = result.document.slug;
        }
      },
      
      formatDate(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp * 1000);
        return date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
      },
      
      getTypeStyles(type) {
        const styles = {
          blog: 'bg-[#54C4B6]/10 text-[#54C4B6]',
          whitepaper: 'bg-[#A8D381]/10 text-[#A8D381]',
          page: 'bg-orange-100 text-orange-600',
          tag: 'bg-gray-100 text-gray-600'
        };
        return styles[type] || styles.tag;
      }
    }
  }
  
  // Register the component when Alpine is ready
  if (window.Alpine) {
    console.log('SearchTypesense: Alpine already loaded, registering component');
    window.Alpine.data('typesenseSearchModal', typesenseSearchModal);
  } else {
    console.log('SearchTypesense: Waiting for Alpine to initialize');
    document.addEventListener('alpine:init', () => {
      console.log('SearchTypesense: Alpine init event fired, registering component');
      Alpine.data('typesenseSearchModal', typesenseSearchModal);
    });
  }
  
  // Also try when Alpine is initialized
  document.addEventListener('alpine:initialized', () => {
    console.log('SearchTypesense: Alpine initialized event fired');
    if (window.Alpine && !window.Alpine.raw(typesenseSearchModal)) {
      console.log('SearchTypesense: Re-registering component after Alpine initialized');
      window.Alpine.data('typesenseSearchModal', typesenseSearchModal);
    }
  });
</script>