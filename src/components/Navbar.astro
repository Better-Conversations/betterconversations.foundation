---
import { Image } from 'astro:assets';
import bcfLogo from '../assets/images/logos/bcf-logo.png';
import Breadcrumb from './Breadcrumb.astro';
import { orgScope } from '../utils/microdata';

export interface Props {
  class?: string;
  showBreadcrumbs?: boolean;
  customBreadcrumbs?: Array<{ name: string; url: string }>;
}

const { class: className = '', showBreadcrumbs = false, customBreadcrumbs } = Astro.props;

const navItems = [
  {
    name: 'Home',
    href: '/'
  },
  {
    name: 'Get Started',
    href: '/get-started',
    dropdown: [
      { name: 'For Organisations', href: '/get-started/organisations' },
      { name: 'For Educators', href: '/get-started/educators' },
      { name: 'For Researchers', href: '/get-started/researchers' },
      { name: 'Join our Community', href: '/get-started/join-community' },
      { name: 'Experience a Course', href: '/get-started/attend-course' },
      { name: 'Book a Call', href: '/get-started/schedule-call' }
    ]
  },
  {
    name: 'Our Approach',
    href: '/approach',
    dropdown: [
      { name: 'Open Content', href: '/approach/open-content' },
      { name: 'FAQs', href: '/approach/faqs' }
    ]
  },
  {
    name: 'Resources',
    href: '/resources',
    dropdown: [
      { name: 'Blog', href: '/blog' },
      { name: 'Documentation', href: 'https://betterconversations.foundation/documentation/index.html' }
    ]
  },
  {
    name: 'About',
    href: '/about',
    dropdown: [
      { name: 'Our Mission', href: '/about/mission' },
      { name: 'Our Team', href: '/about/team' },
      { name: 'Our Ambassadors', href: '/about/showcase' },
      { name: 'Our Appreciation', href: '/about/thanks' },
      { name: 'Contact Us', href: '/about/contact' }
    ]
  }
];
---

<nav class={`fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 transition-all duration-300 ${className}`} id="navbar" aria-label="Main navigation" itemscope itemtype="https://schema.org/Organization">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-20 transition-all duration-300 relative" id="navbar-container">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a href="/" class="block logo-link transition-all duration-300" itemprop="url">
          <Image
            src={bcfLogo}
            alt="Better Conversations Foundation"
            height={48}
            width={300}
            class="h-12 w-auto transition-all duration-300"
            id="navbar-logo"
            itemprop="logo"
          />
          <meta itemprop="name" content="Better Conversations Foundation" />
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden lg:block">
        <div class="ml-10 flex items-center space-x-1">
          {navItems.map((item) => (
            <div class="relative nav-item group">
              <a 
                href={item.href} 
                class="text-gray-700 hover:text-gray-900 px-4 py-2 rounded-md text-base font-medium transition-colors inline-flex items-center"
              >
                {item.name}
                {item.dropdown && (
                  <svg class="ml-1 h-4 w-4 transition-transform group-hover:rotate-180" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                )}
              </a>
              
              {item.dropdown && (
                <div class="absolute left-0 mt-0 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-left">
                  <div class="py-1">
                    {item.dropdown.map((dropdownItem) => (
                      <a
                        href={dropdownItem.href}
                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition-colors"
                      >
                        {dropdownItem.name}
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}
          
          <!-- Search Button -->
          <button
            id="search-button"
            class="ml-4 p-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
            aria-label="Open search"
            title="Search (Cmd/Ctrl + K)"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile menu button and search -->
      <div class="lg:hidden flex items-center gap-2">
        <button
          id="search-button-mobile"
          class="p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors"
          aria-label="Open search"
          title="Search"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
        <button
          type="button"
          class="mobile-menu-button inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
          aria-controls="mobile-menu"
          aria-expanded="false"
        >
          <span class="sr-only">Open main menu</span>
          <!-- Hamburger icon -->
          <svg class="hamburger-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <!-- X icon -->
          <svg class="x-icon hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Breadcrumb Navigation -->
    {showBreadcrumbs && (
      <div class="absolute left-0 right-0 -bottom-10 bg-transparent transition-opacity duration-300" id="breadcrumb-container">
        <Breadcrumb path={Astro.url.pathname} customBreadcrumbs={customBreadcrumbs} />
      </div>
    )}
  </div>

  <!-- Mobile menu -->
  <div class="mobile-menu hidden lg:hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1 bg-white/80 backdrop-blur-md border-b border-gray-100">
      {navItems.map((item) => (
        <div class="mobile-nav-item">
          <a 
            href={item.href} 
            class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-lg font-medium flex justify-between items-center"
            data-dropdown={item.dropdown ? 'true' : 'false'}
          >
            {item.name}
            {item.dropdown && (
              <svg class="dropdown-arrow h-4 w-4 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            )}
          </a>
          {item.dropdown && (
            <div class="dropdown-content hidden pl-6 space-y-1">
              {item.dropdown.map((dropdownItem) => (
                <a
                  href={dropdownItem.href}
                  class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md"
                >
                  {dropdownItem.name}
                </a>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </div>
</nav>

<style>
  /* Ensure dropdowns appear above other content */
  .nav-item:hover .absolute {
    z-index: 50;
  }
  
  /* Logo pop effect styles */
  #navbar.at-top {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }
  
  .logo-link {
    display: block;
    position: relative;
  }
  
  #navbar-logo {
    position: relative;
    z-index: 10;
  }
  
  /* Shadow effect when popped out */
  #navbar.at-top #navbar-logo {
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }
  
  /* Hide nav items on mobile when logo is centered */
  @media (max-width: 640px) {
    #navbar.at-top .nav-item {
      opacity: 0.7;
    }
  }
  
  /* Ensure smooth transitions */
  * {
    -webkit-font-smoothing: antialiased;
  }
</style>

<script>
  // Mobile menu toggle
  const mobileMenuButton = document.querySelector('.mobile-menu-button');
  const mobileMenu = document.querySelector('.mobile-menu');
  const hamburgerIcon = document.querySelector('.hamburger-icon');
  const xIcon = document.querySelector('.x-icon');

  mobileMenuButton?.addEventListener('click', () => {
    const isOpen = !mobileMenu?.classList.contains('hidden');
    
    if (isOpen) {
      mobileMenu?.classList.add('hidden');
      hamburgerIcon?.classList.remove('hidden');
      xIcon?.classList.add('hidden');
    } else {
      mobileMenu?.classList.remove('hidden');
      hamburgerIcon?.classList.add('hidden');
      xIcon?.classList.remove('hidden');
    }
  });

  // Mobile dropdown toggle
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
  
  mobileNavItems.forEach(item => {
    const link = item.querySelector('a[data-dropdown="true"]');
    const dropdown = item.querySelector('.dropdown-content');
    const arrow = item.querySelector('.dropdown-arrow');
    
    if (link && dropdown) {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        dropdown.classList.toggle('hidden');
        arrow?.classList.toggle('rotate-180');
      });
    }
  });
</script>

<script>
  // Logo pop effect on scroll
  let lastScrollY = 0;
  const navbar = document.getElementById('navbar');
  const navbarContainer = document.getElementById('navbar-container');
  const logo = document.getElementById('navbar-logo');
  const logoLink = document.querySelector('.logo-link');
  const breadcrumbContainer = document.getElementById('breadcrumb-container');

  function updateNavbar() {
    const scrollY = window.scrollY;

    if (scrollY === 0) {
      // At top - logo pops out vertically, show breadcrumbs
      navbar?.classList.add('at-top');
      navbarContainer?.classList.add('h-24');
      navbarContainer?.classList.remove('h-20');
      logo?.classList.add('h-16');
      logo?.classList.remove('h-12');
      logoLink?.classList.add('transform', 'translate-y-1');
      breadcrumbContainer?.classList.remove('opacity-0', 'invisible');
      breadcrumbContainer?.classList.add('opacity-100');
    } else {
      // Scrolled - logo normal, hide breadcrumbs
      navbar?.classList.remove('at-top');
      navbarContainer?.classList.remove('h-24');
      navbarContainer?.classList.add('h-20');
      logo?.classList.remove('h-16');
      logo?.classList.add('h-12');
      logoLink?.classList.remove('transform', 'translate-y-1');
      breadcrumbContainer?.classList.add('opacity-0', 'invisible');
      breadcrumbContainer?.classList.remove('opacity-100');
    }

    lastScrollY = scrollY;
  }
  
  // Initial state
  updateNavbar();
  
  // Update on scroll
  window.addEventListener('scroll', updateNavbar, { passive: true });
  
  // Update on page navigation (for Astro's client-side routing)
  document.addEventListener('astro:after-swap', updateNavbar);
  
  // Search button handlers
  const setupSearchButtons = () => {
    const searchButton = document.getElementById('search-button');
    const searchButtonMobile = document.getElementById('search-button-mobile');
    
    // Remove any existing listeners first
    searchButton?.replaceWith(searchButton.cloneNode(true));
    searchButtonMobile?.replaceWith(searchButtonMobile.cloneNode(true));
    
    // Get fresh references
    const newSearchButton = document.getElementById('search-button');
    const newSearchButtonMobile = document.getElementById('search-button-mobile');
    
    const openSearch = (e?: Event) => {
      e?.preventDefault();
      
      // For vanilla JS search component - just use the global function
      if (window.openSearchModal) {
        window.openSearchModal();
        return;
      }
      
      // Method 4: Dispatch custom event
      window.dispatchEvent(new CustomEvent('open-search-modal'));
    };
    
    newSearchButton?.addEventListener('click', openSearch);
    newSearchButtonMobile?.addEventListener('click', openSearch);
  };
  
  // Set up buttons after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupSearchButtons);
  } else {
    setupSearchButtons();
  }
  
  // Re-setup after Alpine initializes
  document.addEventListener('alpine:initialized', setupSearchButtons);
  
  // Re-setup after page transitions
  document.addEventListener('astro:after-swap', () => {
    // Small delay to ensure Alpine has processed the new DOM
    setTimeout(setupSearchButtons, 100);
  });
</script>