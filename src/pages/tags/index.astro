---
import Layout from '../../layouts/Layout.astro';
import TagButton from '../../components/TagButton.astro';
import { getAllTags, getPopularTags } from '../../utils/tags';

const allTags = await getAllTags();
const popularTags = await getPopularTags(15);

// Group tags by first letter for alphabetical display
const tagsByLetter = allTags.reduce((acc, tag) => {
  const firstLetter = tag.name[0].toUpperCase();
  if (!acc[firstLetter]) {
    acc[firstLetter] = [];
  }
  acc[firstLetter].push(tag);
  return acc;
}, {} as Record<string, typeof allTags>);

const sortedLetters = Object.keys(tagsByLetter).sort();

// Calculate tag sizes for cloud (min 0.8rem, max 2rem)
const maxCount = Math.max(...allTags.map(t => t.count));
const minCount = Math.min(...allTags.map(t => t.count));
const sizeRange = maxCount - minCount || 1;

function getTagSize(count: number): string {
  const normalized = (count - minCount) / sizeRange;
  const size = 0.8 + (normalized * 1.2); // 0.8rem to 2rem
  return `${size}rem`;
}
---

<Layout title="Browse by Topic - Better Conversations Foundation">
  <style>
    /* Tag cloud animation */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .tag-cloud-item {
      display: inline-block;
      transition: all 0.3s ease;
    }
    
    .tag-cloud-item:hover {
      animation: float 1s ease-in-out infinite;
    }
    
    /* Alphabet navigation */
    .alphabet-nav {
      position: sticky;
      top: 100px;
      height: fit-content;
    }
    
    .letter-section {
      scroll-margin-top: 120px;
    }
    
    /* Stats animation */
    @keyframes statGrow {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .stat-card {
      animation: statGrow 0.5s ease-out forwards;
    }
    
    /* Background pattern */
    .pattern-bg {
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(84, 196, 182, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(168, 211, 129, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(84, 196, 182, 0.05) 0%, transparent 50%);
    }
  </style>

  <!-- Hero Section -->
  <section class="relative overflow-hidden bg-gradient-to-b from-white via-gray-50 to-white py-16 lg:py-24">
    <div class="absolute inset-0 pattern-bg"></div>
    
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
          Browse by <span class="text-[#54C4B6]">Topic</span>
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 max-w-3xl mx-auto">
          Explore our content through topics that matter to you. Find blogs, whitepapers, and resources organized by subject.
        </p>
      </div>
      
      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-12">
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center" style="animation-delay: 0.1s;">
          <div class="text-3xl font-bold text-[#54C4B6] mb-2">{allTags.length}</div>
          <div class="text-gray-600">Total Topics</div>
        </div>
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center" style="animation-delay: 0.2s;">
          <div class="text-3xl font-bold text-[#A8D381] mb-2">
            {allTags.reduce((sum, tag) => sum + tag.sources.blog, 0)}
          </div>
          <div class="text-gray-600">Blog Articles</div>
        </div>
        <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center" style="animation-delay: 0.3s;">
          <div class="text-3xl font-bold text-[#54C4B6] mb-2">
            {allTags.reduce((sum, tag) => sum + tag.sources.whitepapers, 0)}
          </div>
          <div class="text-gray-600">Whitepapers</div>
        </div>
      </div>
    </div>
    
    <!-- Wave separator -->
    <div class="absolute bottom-0 left-0 right-0">
      <svg class="w-full h-16 text-white" preserveAspectRatio="none" viewBox="0 0 1440 54" fill="currentColor">
        <path d="M0,22L60,27.2C120,32,240,43,360,44.7C480,46,600,38,720,30.3C840,22,960,14,1080,16.3C1200,19,1320,32,1380,38.5L1440,45L1440,54L1380,54C1320,54,1200,54,1080,54C960,54,840,54,720,54C600,54,480,54,360,54C240,54,120,54,60,54L0,54Z"></path>
      </svg>
    </div>
  </section>

  <!-- Popular Tags Cloud -->
  <section class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">Popular Topics</h2>
      
      <div class="text-center space-x-3 space-y-3">
        {popularTags.map((tag, index) => (
          <a
            href={`/tags/${tag.name.toLowerCase().replace(/\s+/g, '-')}`}
            class="tag-cloud-item inline-flex items-center px-4 py-2 rounded-full bg-gradient-to-r from-[#54C4B6]/10 to-[#A8D381]/10 hover:from-[#54C4B6] hover:to-[#A8D381] text-gray-700 hover:text-white transition-all duration-300 hover:shadow-lg"
            style={`font-size: ${getTagSize(tag.count)}; animation-delay: ${index * 0.05}s;`}
          >
            #{tag.name}
            <span class="ml-2 text-xs opacity-70">({tag.count})</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- All Tags Alphabetical -->
  <section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-8">All Topics A-Z</h2>
      
      <div class="lg:flex lg:gap-8">
        <!-- Alphabet Navigation (Desktop) -->
        <nav class="hidden lg:block alphabet-nav w-32">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">Jump to</h3>
            <div class="space-y-1">
              {sortedLetters.map(letter => (
                <a
                  href={`#letter-${letter}`}
                  class="block px-3 py-1 text-sm rounded hover:bg-[#54C4B6]/10 hover:text-[#54C4B6] transition-colors"
                >
                  {letter}
                </a>
              ))}
            </div>
          </div>
        </nav>
        
        <!-- Tags List -->
        <div class="flex-1">
          {sortedLetters.map(letter => (
            <div id={`letter-${letter}`} class="letter-section mb-8">
              <h3 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b border-gray-200">
                {letter}
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {tagsByLetter[letter].map(tag => (
                  <a
                    href={`/tags/${tag.name.toLowerCase().replace(/\s+/g, '-')}`}
                    class="group bg-white rounded-lg border border-gray-200 p-4 hover:border-[#54C4B6] hover:shadow-md transition-all duration-300"
                  >
                    <div class="flex items-center justify-between">
                      <h4 class="font-medium text-gray-900 group-hover:text-[#54C4B6] transition-colors">
                        #{tag.name}
                      </h4>
                      <span class="text-sm text-gray-500">
                        {tag.count} {tag.count === 1 ? 'item' : 'items'}
                      </span>
                    </div>
                    <div class="mt-2 flex gap-4 text-xs text-gray-500">
                      {tag.sources.blog > 0 && (
                        <span>{tag.sources.blog} {tag.sources.blog === 1 ? 'blog' : 'blogs'}</span>
                      )}
                      {tag.sources.whitepapers > 0 && (
                        <span>{tag.sources.whitepapers} {tag.sources.whitepapers === 1 ? 'whitepaper' : 'whitepapers'}</span>
                      )}
                    </div>
                  </a>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-r from-[#54C4B6] to-[#A8D381]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold text-white mb-4">Can't find what you're looking for?</h2>
      <p class="text-xl text-white/90 max-w-2xl mx-auto mb-8">
        Try our search feature to find specific content across all our resources.
      </p>
      <button 
        id="open-search"
        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-[#54C4B6] bg-white hover:bg-gray-50 transition-colors"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Search All Content
      </button>
    </div>
  </section>

  <script>
    // Smooth scroll for alphabet navigation
    document.querySelectorAll('a[href^="#letter-"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
    
    // Open search modal (to be implemented)
    document.getElementById('open-search')?.addEventListener('click', () => {
      // This will trigger the search modal when implemented
      console.log('Search modal will open here');
    });
  </script>
</Layout>