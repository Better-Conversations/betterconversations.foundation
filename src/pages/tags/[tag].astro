---
import Layout from '../../layouts/Layout.astro';
import WaveSeparator from '../../components/WaveSeparator.astro';
import TagButton from '../../components/TagButton.astro';
import { getContentByTag, getRelatedTags, normalizeTag } from '../../utils/tags';
import { Image } from 'astro:assets';
import { getBlogImage } from '../../data/blogImages';
import bcfSymbol from '../../assets/images/logos/bcf-symbol.png';

export async function getStaticPaths() {
  const { getAllTags } = await import('../../utils/tags');
  const allTags = await getAllTags();
  
  return allTags.map(tag => ({
    params: { tag: normalizeTag(tag.name) },
    props: { tagName: tag.name }
  }));
}

const { tag } = Astro.params;
const { tagName } = Astro.props;

const taggedContent = await getContentByTag(tag);
const relatedTags = await getRelatedTags(tag, 8);

// Separate content by type
const blogPosts = taggedContent.filter(item => item.type === 'blog');
const whitepapers = taggedContent.filter(item => item.type === 'whitepaper');
const pages = taggedContent.filter(item => item.type === 'page');

// Generate dynamic meta description
const description = `Explore Better Conversations Foundation content about ${tagName}. Articles, resources, and insights from our community and partners.`;
---

<Layout title={`${tagName} - Better Conversations Foundation`} description={description}>
  <style>
    
    /* Type badge styles */
    .type-badge {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 10;
    }
    
    /* Related tags animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .related-tag {
      animation: slideIn 0.5s ease-out forwards;
    }
    
    /* Empty state illustration */
    .empty-state {
      opacity: 0.5;
      filter: grayscale(50%);
    }
  </style>

  <!-- Hero Section -->
  <section class="relative overflow-hidden bg-gradient-to-b from-white via-gray-50 to-white">
    <div class="absolute inset-0 bg-gradient-to-br from-[#54C4B6]/10 via-transparent to-[#A8D381]/10"></div>
    
    <div class="relative max-w-7xl mx-auto px-6 sm:px-8 lg:px-8">
      <div class="text-center">
        <a href="/tags" class="inline-flex items-center text-[#54C4B6] hover:text-[#54C4B6]/80 transition-colors mb-6">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to all topics
        </a>
        
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
          <span class="text-[#54C4B6]">#</span>{tagName}
        </h1>
        
        <div class="flex justify-center gap-6 md:gap-8 text-center mb-8 flex-wrap">
          <div>
            <div class="text-3xl font-bold text-[#54C4B6]">{taggedContent.length}</div>
            <div class="text-lg text-gray-600">Total Items</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-[#A8D381]">{blogPosts.length}</div>
            <div class="text-lg text-gray-600">Blog Posts</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-[#54C4B6]">{whitepapers.length}</div>
            <div class="text-lg text-gray-600">Whitepapers</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-orange-600">{pages.length}</div>
            <div class="text-lg text-gray-600">Pages</div>
          </div>
        </div>
        
        <!-- Related Tags -->
        {relatedTags.length > 0 && (
          <div class="mt-8">
            <p class="text-lg text-gray-600 mb-2">Related topics:</p>
            <div class="flex flex-wrap justify-center gap-1 px-6 sm:px-8 lg:px-8">
              {relatedTags.map((relatedTag, index) => (
                <a
                  href={`/tags/${normalizeTag(relatedTag)}`}
                  class="related-tag"
                  style={`animation-delay: ${index * 0.1}s;`}
                >
                  <TagButton tag={relatedTag} size="sm" />
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
    
    <WaveSeparator topColor="transparent" bottomColor="white" class="absolute bottom-0 left-0 right-0" />
  </section>

  <!-- Content Sections -->
  <section class="bg-white">
    <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-8">
      {blogPosts.length > 0 && (
        <div class="mb-16">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Blog Articles</h2>
          <div class="space-y-4">
            {blogPosts.map(post => {
              // Get optimised image if available
              const postSlug = post.slug.split('/').pop() || '';
              const optimizedImage = getBlogImage(postSlug);
              
              return (
                <article class="bcf-content-card">
                  <a href={post.slug} class="bcf-content-card-link group">
                    <div class="bcf-content-card-body">
                      <div class="bcf-content-card-image">
                        {optimizedImage ? (
                          <Image
                            src={optimizedImage}
                            alt={post.title}
                            class="w-full h-full object-cover"
                          />
                        ) : (
                          <div class="w-full h-full bg-gradient-to-br from-[#54C4B6]/20 to-[#A8D381]/20 flex items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2"></path>
                            </svg>
                          </div>
                        )}
                        <div class="bcf-content-card-badge">
                          <span class="px-2 py-1 bg-[#54C4B6] text-white text-xs font-medium rounded-full">
                            Blog
                          </span>
                        </div>
                      </div>
                      
                      <div class="bcf-content-card-content">
                        <h3 class="bcf-content-card-title">
                          {post.title}
                        </h3>
                        <p class="bcf-content-card-excerpt">
                          {post.excerpt}
                        </p>
                        
                        <div class="bcf-content-card-meta">
                          {post.date && <time datetime={post.date.toISOString()}>{post.date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' })}</time>}
                          {post.authors && (
                            <span>{Array.isArray(post.authors) ? post.authors.join(', ') : post.authors}</span>
                          )}
                          {post.readingTime && <span>{post.readingTime} min read</span>}
                          {post.tags && post.tags.length > 0 && (
                            <div class="flex gap-1 flex-wrap">
                              {post.tags.map((tag) => (
                                <a 
                                  href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                                  class="bcf-content-tag-pill"
                                >
                                  #{tag}
                                </a>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </div>
        </div>
      )}
      
      {whitepapers.length > 0 && (
        <div class="mb-16">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Research & Whitepapers</h2>
          <div class="space-y-4">
            {whitepapers.map(paper => (
              <article class="bcf-content-card">
                <a href={paper.slug} class="bcf-content-card-link group">
                  <div class="bcf-content-card-body">
                    <div class="bcf-content-card-image">
                      <div class="w-full h-full bg-gradient-to-br from-[#A8D381]/20 to-[#54C4B6]/20 flex items-center justify-center">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      </div>
                      <div class="bcf-content-card-badge">
                        <span class="px-2 py-1 bg-[#A8D381] text-white text-xs font-medium rounded-full">
                          Whitepaper
                        </span>
                      </div>
                    </div>
                    
                    <div class="bcf-content-card-content">
                      <h3 class="bcf-content-card-title">
                        {paper.title}
                      </h3>
                      <p class="bcf-content-card-excerpt">
                        {paper.excerpt}
                      </p>
                      
                      <div class="bcf-content-card-meta">
                        {paper.date && <time datetime={paper.date.toISOString()}>{paper.date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short' })}</time>}
                        {paper.authors && (
                          <span>{Array.isArray(paper.authors) ? paper.authors.join(', ') : paper.authors}</span>
                        )}
                        {paper.readingTime && <span>{paper.readingTime} min read</span>}
                        {paper.tags && paper.tags.length > 0 && (
                          <div class="flex gap-1 flex-wrap">
                            {paper.tags.map((tag) => (
                              <a 
                                href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                                class="bcf-content-tag-pill"
                              >
                                {tag}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </div>
      )}

      {pages.length > 0 && (
        <div class="mb-16">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Related Pages</h2>
          <div class="space-y-4">
            {pages.map(page => (
              <article class="bcf-content-card">
                <a href={page.slug} class="bcf-content-card-link group">
                  <div class="bcf-content-card-body">
                    <div class="bcf-content-card-image page-type">
                      <Image
                        src={bcfSymbol}
                        alt="BCF Symbol"
                        class="w-full h-full object-contain p-8"
                      />
                      <div class="bcf-content-card-badge">
                        <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">
                          Page
                        </span>
                      </div>
                    </div>
                    
                    <div class="bcf-content-card-content centred">
                      <h3 class="bcf-content-card-title">
                        {page.title}
                      </h3>
                      <p class="bcf-content-card-excerpt">
                        {page.excerpt}
                      </p>
                      <div class="bcf-content-card-meta">
                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                          </svg>
                          <span>{page.category}</span>
                        </div>
                        {page.tags && page.tags.length > 0 && (
                          <div class="flex gap-1 flex-wrap">
                            {page.tags.map((tag) => (
                              <a 
                                href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                                class="bcf-content-tag-pill"
                              >
                                #{tag}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </div>
      )}
      
      {taggedContent.length === 0 && (
        <div class="text-center py-20">
          <div class="empty-state inline-block mb-8">
            <svg class="w-32 h-32 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-medium text-gray-900 mb-2">No content found</h3>
          <p class="text-gray-600 mb-8">We don't have any content tagged with "{tagName}" yet.</p>
          <a href="/tags" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-[#54C4B6] hover:bg-[#54C4B6]/90 transition-colors">
            Browse other topics
          </a>
        </div>
      )}
    </div>
  </section>
</Layout>