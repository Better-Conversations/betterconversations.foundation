---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getAllTags } from '../../utils/tags';
import { pageMetadata } from '../../data/pageMetadata';
import { generateMetaProperties } from '../../utils/metadata';

// Get search query from URL
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const filter = url.searchParams.get('filter') || 'all';

// Get all content
const [blogs, whitepapers, tags] = await Promise.all([
  getCollection('blog'),
  getCollection('whitepapers'),
  getAllTags()
]);

// Define the search result type
interface SearchResult {
  type: 'blog' | 'whitepaper' | 'page' | 'tag';
  title: string;
  excerpt?: string;
  slug: string;
  tags?: string[];
  author?: string;
  authors?: string[];
  date?: Date;
  category?: string;
  count?: number;
}

// Get recent blog posts for the initial state
const recentBlogs = blogs
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

// Perform search if query exists
let results: SearchResult[] = [];
if (query) {
  const searchTerm = query.toLowerCase();
  
  // Search blogs
  if (filter === 'all' || filter === 'blog') {
    const blogResults = blogs
      .filter(post =>
        post.data.title.toLowerCase().includes(searchTerm) ||
        post.data.excerpt.toLowerCase().includes(searchTerm) ||
        
        post.data.tags.some(tag => tag.toLowerCase().includes(searchTerm))
      )
      .map(post => ({
        type: 'blog' as const,
        title: post.data.title,
        excerpt: post.data.excerpt,
        slug: `/blog/${post.slug}`,
        tags: post.data.tags,
        author: post.data.author,
        date: post.data.date,
        category: post.data.category
      }));
    results.push(...blogResults);
  }
  
  // Search whitepapers
  if (filter === 'all' || filter === 'whitepaper') {
    const whitepaperResults = whitepapers
      .filter(paper =>
        paper.data.title.toLowerCase().includes(searchTerm) ||
        paper.data.excerpt.toLowerCase().includes(searchTerm) ||
        paper.data.tags.some(tag => tag.toLowerCase().includes(searchTerm))
      )
      .map(paper => ({
        type: 'whitepaper' as const,
        title: paper.data.title,
        excerpt: paper.data.excerpt,
        slug: `/whitepapers/${paper.slug}`,
        tags: paper.data.tags,
        authors: paper.data.authors,
        date: paper.data.date,
        category: paper.data.category
      }));
    results.push(...whitepaperResults);
  }
  
  // Search pages
  if (filter === 'all' || filter === 'page') {
    const pageResults = Object.entries(pageMetadata)
      .filter(([path, page]) =>
        page.title.toLowerCase().includes(searchTerm) ||
        page.excerpt.toLowerCase().includes(searchTerm) ||
        page.tags.some(tag => tag.toLowerCase().includes(searchTerm))
      )
      .map(([path, page]) => ({
        type: 'page' as const,
        title: page.title,
        excerpt: page.excerpt,
        slug: path,
        tags: page.tags,
        category: page.category
      }));
    results.push(...pageResults);
  }
  
  // Search tags
  if (filter === 'all' || filter === 'tag') {
    const tagResults = tags
      .filter(tag => tag.name.toLowerCase().includes(searchTerm))
      .map(tag => ({
        type: 'tag' as const,
        title: tag.name,
        count: tag.count,
        slug: `/tags/${tag.name.toLowerCase().replace(/\s+/g, '-')}`
      }));
    results.push(...tagResults);
  }
}

// Sort results by relevance (title matches first, then by date)
results.sort((a, b) => {
  const aInTitle = a.title.toLowerCase().includes(query.toLowerCase());
  const bInTitle = b.title.toLowerCase().includes(query.toLowerCase());
  
  if (aInTitle && !bInTitle) return -1;
  if (!aInTitle && bInTitle) return 1;
  
  // For items with dates, sort by date
  if ('date' in a && 'date' in b && a.date && b.date) {
    return b.date.getTime() - a.date.getTime();
  }
  
  // Put items with dates before items without dates
  if ('date' in a && a.date && !('date' in b)) return -1;
  if ('date' in b && b.date && !('date' in a)) return 1;
  
  return 0;
});

// Generate enhanced metadata for the search page
const searchMetadata = generateMetaProperties('/search', {
  title: query ? `Search results for "${query}"` : 'Search - Better Conversations Foundation',
  description: query ? 
    `Search results for "${query}" across the Foundation's resources, blogs, and whitepapers.` :
    'Search the Foundation\'s complete library of resources, blogs, and whitepapers.'
});
---

<Layout 
  title={searchMetadata.title}
  description={searchMetadata.description}
  keywords={searchMetadata.keywords}
  schemaType="SearchResultsPage"
>
  <style>
    /* Match modal search styles */
    .search-container {
      max-width: 56rem; /* 896px - matches max-w-4xl */
      margin: 0 auto;
    }
    
    /* Filter button styles to match modal */
    .search-filter {
      background-color: #f9fafb;
      color: #6b7280;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    
    .search-filter:hover {
      background-color: #f3f4f6;
      border-color: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .search-filter.active {
      background: linear-gradient(to right, #54C4B6, #A8D381);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* Result item styles to match modal */
    .search-result-item {
      display: block;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      background-color: white;
      transition: all 0.2s;
    }
    
    .search-result-item:hover {
      background-color: #f0fdf4;
      border-color: #54C4B6;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .search-result-item.active {
      background-color: #e0f7fa !important;
      border-color: #54C4B6 !important;
      box-shadow: 0 0 0 2px rgba(84, 196, 182, 0.2) !important;
    }
    
    /* Type badges to match modal */
    .result-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.125rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
    }
    
    .result-type-blog {
      background-color: rgba(84, 196, 182, 0.1);
      color: #54C4B6;
    }
    
    .result-type-whitepaper {
      background-color: rgba(168, 211, 129, 0.1);
      color: #A8D381;
    }
    
    .result-type-tag {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    
    .result-type-page {
      background-color: rgba(249, 115, 22, 0.1);
      color: #ea580c;
    }
    
    .line-clamp-2 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>

  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
    <!-- Search Header -->
    <div class="pt-24 pb-6 border-b border-gray-200 bg-white">
      <div class="search-container px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-4 relative">
          <svg class="w-6 h-6 text-[#54C4B6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <form method="get" action="/search" class="flex-1 flex items-center gap-4">
            <input
              type="text"
              name="q"
              id="search-input"
              value={query}
              placeholder="Search blogs, whitepapers, and topics..."
              class="flex-1 text-lg bg-transparent outline-none placeholder-gray-400 text-gray-900 font-medium"
              autocomplete="off"
              autofocus
            />
            <input type="hidden" name="filter" value={filter} id="filter-input" />
            <!-- Keyboard shortcut hint -->
            <div class="hidden sm:flex items-center gap-2 text-sm text-gray-400">
              <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">Cmd+K</kbd>
              <span>for quick search</span>
            </div>
          </form>
        </div>
        
        <!-- Filters -->
        <div class="flex flex-wrap gap-2 mt-6">
          <button class={`search-filter px-3 py-1 text-sm rounded-full transition-colors ${filter === 'all' ? 'active' : ''}`} data-type="all">
            All
          </button>
          <button class={`search-filter px-3 py-1 text-sm rounded-full transition-colors ${filter === 'blog' ? 'active' : ''}`} data-type="blog">
            Blogs
          </button>
          <button class={`search-filter px-3 py-1 text-sm rounded-full transition-colors ${filter === 'whitepaper' ? 'active' : ''}`} data-type="whitepaper">
            Whitepapers
          </button>
          <button class={`search-filter px-3 py-1 text-sm rounded-full transition-colors ${filter === 'page' ? 'active' : ''}`} data-type="page">
            Pages
          </button>
          <button class={`search-filter px-3 py-1 text-sm rounded-full transition-colors ${filter === 'tag' ? 'active' : ''}`} data-type="tag">
            Topics
          </button>
        </div>
      </div>
    </div>
    
    <!-- Search Results -->
    <div class="max-h-[calc(100vh-280px)] overflow-y-auto">
      <div class="search-container px-4 sm:px-6 lg:px-8 py-6">
        {query ? (
          results.length > 0 ? (
            <div class="search-results-container">
              {results.map((result, index) => {
                let typeClass = '';
                let typeName = '';
                
                switch (result.type) {
                  case 'blog':
                    typeClass = 'result-type-blog';
                    typeName = 'Blog';
                    break;
                  case 'whitepaper':
                    typeClass = 'result-type-whitepaper';
                    typeName = 'Whitepaper';
                    break;
                  case 'tag':
                    typeClass = 'result-type-tag';
                    typeName = 'Topic';
                    break;
                  case 'page':
                    typeClass = 'result-type-page';
                    typeName = 'Page';
                    break;
                }
                
                return result.type === 'tag' ? (
                  <a href={result.slug} 
                     class="search-result-item" 
                     data-index={index}>
                    <div class="flex items-center justify-between gap-4">
                      <div>
                        <h3 class="font-semibold text-gray-900 text-lg mb-1 transition-colors">
                          <span class="text-[#54C4B6]">#</span>{result.title}
                        </h3>
                        <p class="text-sm text-gray-600">{result.count} {result.count === 1 ? 'item' : 'items'}</p>
                      </div>
                      <span class={`result-type-badge ${typeClass}`}>{typeName}</span>
                    </div>
                  </a>
                ) : (
                  <a href={result.slug} 
                     class="search-result-item" 
                     data-index={index}>
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-gray-900 text-lg mb-1 truncate transition-colors">{result.title}</h3>
                        <p class="text-sm text-gray-600 line-clamp-2 mb-2">{result.excerpt}</p>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                          {result.date && <time>{new Date(result.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'short' })}</time>}
                          {result.tags && result.tags.length > 0 && (
                            <>
                              <span class="text-gray-400">•</span>
                              <span>{result.tags.slice(0, 2).join(', ')}</span>
                            </>
                          )}
                        </div>
                      </div>
                      <span class={`result-type-badge ${typeClass} flex-shrink-0`}>{typeName}</span>
                    </div>
                  </a>
                );
              })}
            </div>
          ) : (
            <!-- No results -->
            <div class="text-center py-12">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-lg font-medium text-gray-900 mb-2">No results found</p>
              <p class="text-sm text-gray-600">Try adjusting your search or filters</p>
            </div>
          )
        ) : (
          <!-- Initial state with popular topics -->
          <div class="max-w-4xl mx-auto">
            <div class="mb-8">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">Popular Topics</h2>
              <div class="flex flex-wrap gap-2">
                <a href="/search?q=communication" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Communication
                </a>
                <a href="/search?q=facilitation" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Facilitation
                </a>
                <a href="/search?q=leadership" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Leadership
                </a>
                <a href="/search?q=coaching" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Coaching
                </a>
                <a href="/search?q=methodology" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Methodology
                </a>
                <a href="/search?q=research" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  Research
                </a>
              </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Recent Blog Posts</h3>
                <div class="space-y-3">
                  {recentBlogs.map(post => (
                    <a href={`/blog/${post.slug}`} class="block group">
                      <h4 class="font-medium text-gray-900 group-hover:text-[#54C4B6] transition-colors">
                        {post.data.title}
                      </h4>
                      <p class="text-sm text-gray-500 mt-1">
                        {new Date(post.data.date).toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' })}
                      </p>
                    </a>
                  ))}
                  <a href="/blog" class="block text-[#54C4B6] hover:text-[#54C4B6]/80 transition-colors mt-4">
                    View all blog posts →
                  </a>
                </div>
              </div>
              
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Browse by Type</h3>
                <div class="space-y-2">
                  <a href="/search?filter=blog" class="block text-gray-600 hover:text-[#54C4B6] transition-colors">
                    Blog Articles
                  </a>
                  <a href="/search?filter=whitepaper" class="block text-gray-600 hover:text-[#54C4B6] transition-colors">
                    Whitepapers & Research
                  </a>
                  <a href="/search?filter=page" class="block text-gray-600 hover:text-[#54C4B6] transition-colors">
                    Foundation Pages
                  </a>
                  <a href="/tags" class="block text-gray-600 hover:text-[#54C4B6] transition-colors">
                    All Topics
                  </a>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
    
    <!-- Footer with keyboard shortcuts - only show when there are results -->
    {query && (
      <div class="p-4 sm:px-6 border-t border-gray-200 bg-gradient-to-br from-gray-50 to-gray-100/50">
        <div class="search-container flex flex-col sm:flex-row items-center justify-between gap-2 text-sm text-gray-500">
          <div class="flex items-center gap-3 text-xs sm:text-sm">
            <span class="flex items-center gap-1.5">
              <kbd class="px-2 py-1 bg-white border border-gray-300 rounded text-xs font-mono shadow-sm">↑</kbd>
              <kbd class="px-2 py-1 bg-white border border-gray-300 rounded text-xs font-mono shadow-sm">↓</kbd>
              <span class="hidden sm:inline">Navigate</span>
            </span>
            <span class="text-gray-400">•</span>
            <span class="flex items-center gap-1.5">
              <kbd class="px-2 py-1 bg-white border border-gray-300 rounded text-xs font-mono shadow-sm">Enter</kbd>
              <span class="hidden sm:inline">Select</span>
            </span>
          </div>
          <div class="search-result-count">
            <span class="font-medium">{results.length}</span> {results.length === 1 ? 'result' : 'results'}
          </div>
        </div>
      </div>
    )}
  </div>

  <script>
    // Initialize search functionality
    let selectedIndex = -1;
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const filterInput = document.getElementById('filter-input') as HTMLInputElement;
    const filterButtons = document.querySelectorAll('.search-filter');
    
    // Filter button clicks
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const newFilter = button.getAttribute('data-type') || 'all';
        filterInput.value = newFilter;
        
        // Submit form to update results
        if (searchInput.value) {
          searchInput.form?.submit();
        } else {
          // Update active state without submitting if no query
          filterButtons.forEach(b => b.classList.remove('active'));
          button.classList.add('active');
        }
      });
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const results = document.querySelectorAll('.search-result-item');
      
      if (results.length > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
          updateSelectedResult();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedResult();
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          const selectedLink = results[selectedIndex] as HTMLAnchorElement;
          if (selectedLink) {
            window.location.href = selectedLink.href;
          }
        }
      }
      
      // Cmd/Ctrl + K to open modal search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (window.openSearchModal) {
          window.openSearchModal();
        }
      }
    });
    
    // Update selected result visual state
    function updateSelectedResult() {
      const results = document.querySelectorAll('.search-result-item');
      results.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('active');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // Auto-submit on input after delay
    let searchTimeout: number;
    searchInput?.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = window.setTimeout(() => {
        searchInput.form?.submit();
      }, 500);
    });
  </script>
</Layout>