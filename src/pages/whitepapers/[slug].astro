---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const whitepapers = await getCollection('whitepapers');
  
  return whitepapers.map((paper) => ({
    params: { slug: paper.slug },
    props: { paper },
  }));
}

type Props = {
  paper: CollectionEntry<'whitepapers'>;
};

const { paper } = Astro.props;
const { Content } = await paper.render();

// Get related whitepapers (same category, different paper)
const allWhitepapers = await getCollection('whitepapers');
const relatedWhitepapers = allWhitepapers
  .filter(p => p.data.category === paper.data.category && p.slug !== paper.slug)
  .slice(0, 3);
---

<Layout title={`${paper.data.title} - Better Conversations Foundation`}>
  <style>
    /* Progress indicator */
    .reading-progress {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, #54C4B6, #A8D381);
      transform-origin: left;
      transform: scaleX(0);
      transition: transform 0.1s ease;
      z-index: 50;
    }
    
    /* Table of contents */
    .toc-item {
      @apply block py-2 px-4 text-gray-600 hover:text-[#54C4B6] hover:bg-gray-50 rounded transition-colors;
    }
    
    .toc-item.active {
      @apply text-[#54C4B6] bg-[#54C4B6]/10;
    }
  </style>

  <!-- Reading Progress Bar -->
  <div class="reading-progress"></div>

  <!-- Hero Section -->
  <section class="relative bg-gradient-to-b from-gray-50 to-white pt-24 pb-16">
    <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-500 mb-8">
          <a href="/" class="hover:text-[#54C4B6]">Home</a>
          <span>/</span>
          <a href="/whitepapers" class="hover:text-[#54C4B6]">Whitepapers</a>
          <span>/</span>
          <span class="text-gray-900">{paper.data.title}</span>
        </nav>

        <!-- Paper Header -->
        <div class="mb-8">
          <div class="flex flex-wrap items-center gap-3 mb-6">
            <span class="px-4 py-2 bg-[#54C4B6]/10 text-[#54C4B6] text-sm font-medium rounded-full">
              {paper.data.category}
            </span>
            {paper.data.featured && (
              <span class="px-4 py-2 bg-gradient-to-r from-[#54C4B6] to-[#A8D381] text-white text-sm font-medium rounded-full">
                Featured Research
              </span>
            )}
          </div>
          
          <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
            {paper.data.title}
          </h1>
          
          <p class="text-xl text-gray-600 mb-8">
            {paper.data.excerpt}
          </p>
          
          <!-- Meta Information -->
          <div class="flex flex-wrap items-center gap-6 text-gray-600 pb-8 border-b border-gray-200">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              <span class="font-medium">Authors:</span> {paper.data.authors.join(", ")}
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <time datetime={paper.data.date.toISOString()}>{paper.data.date.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              {paper.data.readingTime || 15} min read
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Content Section -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-8">
      <div class="grid lg:grid-cols-12 gap-12">
        <!-- Table of Contents (Sticky Sidebar) -->
        <aside class="lg:col-span-3" role="complementary" aria-label="Table of contents">
          <div class="sticky top-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Table of Contents</h3>
            <nav id="toc" class="space-y-1">
              <!-- TOC will be populated by JavaScript -->
            </nav>
            
            <!-- Download Section -->
            <div class="mt-8 p-6 bg-gray-50 rounded-lg">
              <h4 class="font-semibold text-gray-900 mb-3">Download Options</h4>
              <div class="space-y-3">
                {paper.data.downloadUrl ? (
                  <a 
                    href={paper.data.downloadUrl}
                    class="block w-full text-center px-4 py-2 bg-[#54C4B6] text-white rounded-lg hover:bg-[#54C4B6]/90 transition-colors"
                    download
                  >
                    Download PDF
                  </a>
                ) : (
                  <button 
                    id="download-pdf"
                    class="block w-full text-center px-4 py-2 bg-[#54C4B6] text-white rounded-lg hover:bg-[#54C4B6]/90 transition-colors"
                  >
                    Generate PDF
                  </button>
                )}
                <button 
                  id="print-paper"
                  class="block w-full text-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Print Paper
                </button>
              </div>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:col-span-9">
          <article class="prose prose-lg max-w-none bg-white rounded-xl p-8 lg:p-12 shadow-sm border border-gray-100
            prose-headings:text-gray-900 prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 
            prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4 prose-h4:text-xl prose-h4:mt-6 prose-h4:mb-3
            prose-p:text-gray-600 prose-p:leading-relaxed prose-p:mb-6
            prose-a:text-[#54C4B6] prose-a:underline hover:prose-a:text-[#54C4B6]/80
            prose-strong:text-gray-900 prose-blockquote:border-l-4 prose-blockquote:border-[#54C4B6]
            prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-700
            prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm
            prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:p-4 prose-pre:rounded-lg
            prose-table:border-collapse prose-th:bg-gray-100 prose-th:p-4 prose-th:text-left
            prose-th:border-b-2 prose-th:border-gray-300 prose-td:p-4 prose-td:border-b prose-td:border-gray-200
            prose-img:rounded-lg prose-img:shadow-md">
            <Content />
          </article>

          <!-- Tags -->
          {paper.data.tags.length > 0 && (
            <div class="mt-12">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Related Topics</h3>
              <div class="flex flex-wrap gap-2">
                {paper.data.tags.map((tag) => (
                  <a 
                    href={`/whitepapers?tag=${encodeURIComponent(tag)}`}
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors text-sm"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Share Section -->
          <div class="mt-12 p-6 bg-gradient-to-r from-[#54C4B6]/10 to-[#A8D381]/10 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Share This Research</h3>
            <div class="flex gap-4">
              <button 
                class="share-btn flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                data-platform="linkedin"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                </svg>
                LinkedIn
              </button>
              <button 
                class="share-btn flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                data-platform="twitter"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"/>
                </svg>
                Twitter
              </button>
              <button 
                class="share-btn flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                data-platform="copy"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Copy Link
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>
  </section>

  <!-- Related Whitepapers -->
  {relatedWhitepapers.length > 0 && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Related Research</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedWhitepapers.map((related) => (
            <article class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
              <span class="inline-block px-3 py-1 bg-gray-100 text-gray-700 text-sm font-medium rounded-full mb-3">
                {related.data.category}
              </span>
              <h3 class="text-lg font-semibold text-gray-900 mb-2 hover:text-[#54C4B6] transition-colors">
                <a href={`/whitepapers/${related.slug}`}>
                  {related.data.title}
                </a>
              </h3>
              <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                {related.data.excerpt}
              </p>
              <div class="text-sm text-gray-500">
                {related.data.readingTime || 15} min read
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <script>
    // Generate Table of Contents
    function generateTOC() {
      const tocContainer = document.getElementById('toc');
      const headings = document.querySelectorAll('.mdx-content h2, .mdx-content h3');
      
      if (!tocContainer) return;
      
      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;
        
        const tocItem = document.createElement('a');
        tocItem.href = `#${id}`;
        tocItem.className = 'toc-item';
        tocItem.textContent = heading.textContent;
        
        if (heading.tagName === 'H3') {
          tocItem.style.paddingLeft = '2rem';
        }
        
        tocContainer.appendChild(tocItem);
      });
    }
    
    // Update active TOC item on scroll
    function updateActiveTOC() {
      const headings = document.querySelectorAll('.mdx-content h2, .mdx-content h3');
      const tocItems = document.querySelectorAll('.toc-item');
      
      let currentActiveIndex = -1;
      
      headings.forEach((heading, index) => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom > 0) {
          currentActiveIndex = index;
        }
      });
      
      tocItems.forEach((item, index) => {
        if (index === currentActiveIndex) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // Update reading progress
    function updateReadingProgress() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (scrollTop / docHeight) * 100;
      
      const progressBar = document.querySelector('.reading-progress') as HTMLElement;
      if (progressBar) {
        progressBar.style.transform = `scaleX(${progress / 100})`;
      }
    }
    
    // Share functionality
    document.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', function(this: HTMLElement) {
        const platform = this.getAttribute('data-platform');
        const url = window.location.href;
        const title = document.querySelector('h1')?.textContent || '';
        
        let shareUrl = '';
        
        switch(platform) {
          case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            break;
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
            break;
          case 'copy':
            navigator.clipboard.writeText(url);
            alert('Link copied to clipboard!');
            return;
        }
        
        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
      });
    });
    
    // Download/Print functionality
    document.getElementById('download-pdf')?.addEventListener('click', async () => {
      const button = document.getElementById('download-pdf') as HTMLButtonElement;
      const originalText = button.textContent || 'Generate PDF';
      
      try {
        // Update button state
        button.textContent = 'Generating PDF...';
        button.disabled = true;
        
        // Get the current slug from the URL
        const pathParts = window.location.pathname.split('/');
        const slug = pathParts[pathParts.length - 1];
        
        // Call the API to generate PDF
        const response = await fetch(`/api/whitepapers/${slug}/pdf`);
        
        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }
        
        // Get the blob and create download link
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = response.headers.get('content-disposition')?.split('filename="')[1]?.slice(0, -1) || `whitepaper-${slug}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Reset button
        button.textContent = 'PDF Downloaded!';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 3000);
      } catch (error) {
        console.error('PDF generation error:', error);
        button.textContent = 'Error generating PDF';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 3000);
      }
    });
    
    document.getElementById('print-paper')?.addEventListener('click', () => {
      window.print();
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      generateTOC();
      updateActiveTOC();
      updateReadingProgress();
    });
    
    // Update on scroll
    window.addEventListener('scroll', () => {
      updateActiveTOC();
      updateReadingProgress();
    });
  </script>
</Layout>